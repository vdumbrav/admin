# Архитектура и Спецификация Системы Квестов

Комплексная документация Системы Управления Квестами, включая Пресеты, Создание Мульти-Задач и Управление Дочерними Задачами.

---

## Содержание

1. [Основная Система Квестов](#основная-система-квестов)
2. [Типы и Структура Квестов](#типы-и-структура-квестов)
3. [Система Конфигурации Пресетов](#система-конфигурации-пресетов)
4. [Создание Мульти-Задач](#создание-мульти-задач)
5. [Управление Формами](#управление-формами)
6. [Интеграция с API](#интеграция-с-api)
7. [UI Компоненты](#ui-компоненты)
8. [Руководство по Разработке](#руководство-по-разработке)

---

## Основная Система Квестов

### Обзор

Система Квестов - это гибкая, конфигурируемая платформа для создания и управления различными типами пользовательских задач и наград. Система поддерживает:

- **Одиночные Задачи**: Самостоятельные квесты с индивидуальными наградами
- **Мульти-Задачи**: Родительские квесты с несколькими дочерними задачами
- **Конфигурация на Основе Пресетов**: Предопределенные шаблоны квестов
- **Динамическое Управление Полями**: Контекстно-зависимые поля форм
- **Отслеживание Прогресса**: Мониторинг создания и выполнения в реальном времени

### Архитектурные Принципы

- **Конфигурация вместо Кода**: Поведение квестов определяется через конфигурации пресетов
- **Наследование**: Дочерние задачи наследуют свойства от родительских квестов
- **Композиция**: Гибкое комбинирование компонентов квестов
- **Валидация**: Многоуровневая система валидации (Форма → Пресет → API)

---

## Типы и Структура Квестов

### Основные Типы Квестов

| Тип | Описание | Случай Использования | Дочерние Задачи |
|-----|----------|---------------------|-----------------|
| `connect` | Подключение социальных аккаунтов | Связать Twitter/Discord/Telegram | Нет |
| `join` | Присоединение к каналам/группам | Присоединиться к Telegram каналам | Нет |
| `share` | Шаринг контента | Поделиться постами/ссылками | Нет |
| `like` | Социальные взаимодействия | Лайкнуть твиты/посты | Нет |
| `comment` | Пользовательское вовлечение | Комментировать контент | Нет |
| `multiple` | **Контейнер мульти-задач** | **Кампании действий** | **Да** |
| `repeatable` | Ежедневные/повторяющиеся задачи | Серии входов, ежедневные награды | Нет |
| `external` | Посещение внешних сайтов | Посетить партнерские сайты | Нет |
| `referral` | Пользовательские рефералы | Пригласить друзей | Нет |
| `dummy` | Тестирование/заполнитель | Цели разработки | Нет |

### Группы Квестов

- **`all`**: Группа по умолчанию, видна везде
- **`social`**: Взаимодействия в социальных сетях
- **`daily`**: Ежедневные повторяющиеся задачи
- **`referral`**: Задачи реферальной программы
- **`partner`**: Квесты партнерского сотрудничества

### Провайдеры

- **`twitter`**: Интеграция с платформой Twitter/X
- **`telegram`**: Интеграция с ботом/каналом Telegram
- **`discord`**: Интеграция с сервером Discord
- **`matrix`**: Поддержка протокола Matrix
- **`walme`**: Платформа WalMe
- **`monetag`**: Реклама MonetAg
- **`adsgram`**: Рекламная платформа Adsgram

---

## Система Конфигурации Пресетов

### Что такое Пресеты?

Пресеты - это шаблоны конфигурации, которые определяют поведение квестов, видимость полей, правила валидации и бизнес-логику. Они обеспечивают последовательное создание квестов при сохранении гибкости.

### Структура Пресета

```typescript
interface PresetConfig {
  id: string;                    // Уникальный идентификатор пресета
  name: string;                  // Отображаемое имя
  fieldVisibility: FieldVisibilityConfig;  // Управление полями формы
  defaults: Partial<QuestFormValues>;      // Значения по умолчанию
  businessRules: BusinessRule[];           // Правила автогенерации
  connectGateRules?: ConnectGateConfig;    // Требования Connect квестов
  rewardCalculation?: RewardConfig;        // Вычисление наград
  specialComponents?: string[];            // Кастомные UI компоненты
}
```

### Доступные Пресеты

#### 1. Действие с Постом (`action-with-post`)

- **Цель**: Кампании вовлечения в Twitter (Лайк + Комментарий + Ретвит)
- **Тип**: `multiple` с дочерними задачами
- **Функции**:
  - Динамическое управление дочерними задачами
  - Автоматический расчет наград
  - Интеграция предпросмотра Twitter
  - Бизнес-правила для генерации текста кнопок

#### 2. Подключение (`connect`)

- **Цель**: Связывание социальных аккаунтов
- **Тип**: `connect`
- **Функции**:
  - Обязательный выбор провайдера
  - Готовность к OAuth интеграции
  - Шлюз для других социальных квестов

#### 3. Присоединение (`join`)

- **Цель**: Членство в каналах/группах
- **Тип**: `join`
- **Функции**:
  - Обязательная валидация URI
  - Логика присоединения для конкретного провайдера
  - Интеграция верификации

#### 4. Исследование (`explore`)

- **Цель**: Посещения внешних сайтов
- **Тип**: `external`
- **Функции**:
  - Кастомные описания всплывающих окон
  - Требования к иконкам
  - Кастомизация кнопок

#### 5. Семидневный Вызов (`seven-day-challenge`)

- **Цель**: Кампании ежедневных наград
- **Тип**: `repeatable`
- **Функции**:
  - Карта наград на 3-10 дней
  - Конфигурация итератора
  - Отслеживание прогресса

### Матрица Видимости Полей

| Поле | action-with-post | connect | join | explore | seven-day |
|------|------------------|---------|------|---------|-----------|
| type | readonly | readonly | readonly | readonly | readonly |
| provider | readonly | visible | visible | hidden | hidden |
| uri | hidden | hidden | visible | visible | hidden |
| tasks | visible | hidden | hidden | hidden | hidden |
| dailyRewards | hidden | hidden | hidden | hidden | visible |
| totalReward | readonly | hidden | hidden | readonly | readonly |
| buttonText | hidden | hidden | hidden | visible | hidden |
| popupDescription | hidden | hidden | hidden | visible | hidden |
| icon | conditional | hidden | hidden | visible | hidden |

---

## Создание Мульти-Задач

### Архитектура

Создание мульти-задач позволяет создавать сложные кампании квестов, где родительский квест содержит несколько дочерних задач. Это в основном используется для кампаний вовлечения в социальных сетях.

### Диаграмма Потока

```
1. Отправка Формы
   ↓
2. Создание Основного Квеста (POST /api/admin/tasks)
   ├── Успех → Продолжить с дочерними
   └── Неудача → Остановиться с ошибкой
   ↓
3. Последовательное Создание Дочерних
   ├── Для каждого дочернего: POST /api/admin/tasks + parent_id
   ├── Обновления прогресса в реальном времени
   ├── Индивидуальная обработка ошибок
   └── Возможность повтора для неудачных задач
   ↓
4. Итоговый Результат
   ├── Полный Успех: Все задачи созданы
   ├── Частичный Успех: Основная + некоторые дочерние
   └── Полная Неудача: Задачи не созданы
```

### Структура Дочерней Задачи

Дочерние задачи наследуют ключевые свойства от своего родителя, сохраняя при этом свои собственные специфические конфигурации:

```typescript
interface ChildFormValues {
  // Основная идентификация
  title: string;
  type: ChildType;  // 'like' | 'share' | 'comment' | 'join' | 'connect'
  group: QuestGroup;
  provider?: Provider;
  order_by: number;

  // Дополнительная конфигурация
  description?: string;
  reward?: number;
  uri?: string;      // Для типов join/connect
  icon?: string;     // Кастомная иконка дочерней задачи

  // Наследуется от родителя (если не указано)
  enabled?: boolean;  // По умолчанию: наследуется от родителя
  web?: boolean;      // По умолчанию: наследуется от родителя
  twa?: boolean;      // По умолчанию: наследуется от родителя
  pinned?: boolean;   // По умолчанию: false для дочерних
  level?: number;     // По умолчанию: 1 для дочерних

  // Временные ограничения
  start?: string;
  end?: string;

  // Ресурсы (расширенная поддержка)
  resources?: {
    tweetId?: string;
    username?: string;
    icon?: string;
    ui?: UIResources;
  };
}
```

### Правила Наследования

1. **Настройки Платформы**: `enabled`, `web`, `twa` наследуются от родителя, если не указаны
2. **Провайдер**: Обычно наследуется от родительского квеста
3. **Группа**: Обычно соответствует группе родителя
4. **Время**: Может наследовать ограничения `start`/`end`
5. **Уровень**: Дочерние обычно имеют уровень 1

### Отслеживание Прогресса

Система предоставляет отслеживание прогресса в реальном времени со следующими состояниями:

- **`pending`**: Ожидает создания
- **`creating`**: В процессе создания
- **`success`**: Успешно создана
- **`error`**: Создание не удалось (можно повторить)
- **`skipped`**: Намеренно пропущена

---

## Управление Формами

### Архитектура Форм

Система форм квестов использует React Hook Form с валидацией Zod, организованную в модульные компоненты:

#### Основные Компоненты

1. **`QuestFormContainer`**: Главный оркестратор форм
2. **`QuestFormFields`**: Рендеринг полей на основе конфигурации пресета
3. **`ChildrenEditor`**: Интерфейс управления дочерними задачами
4. **`MultiTaskProgress`**: Визуализация прогресса создания

#### Ключевые Функции

- **Динамическая Видимость Полей**: На основе конфигурации пресета
- **Валидация в Реальном Времени**: Валидация схемы Zod с правилами, специфичными для пресета
- **Движок Бизнес-Правил**: Автоматическое заполнение полей на основе условий
- **Интеграция Мульти-Задач**: Бесшовный рабочий процесс создания дочерних задач

### Редактор Дочерних Задач

Компонент `ChildrenEditor` предоставляет:

- **Перетаскивание для Переупорядочивания**: Визуальное управление порядком задач
- **Динамическое Добавление/Удаление**: Добавление/удаление дочерних задач по требованию
- **Поля, Специфичные для Типа**: Показ релевантных полей на основе типа дочерней задачи
- **Автопрокрутка**: Плавная прокрутка к новым задачам
- **Управление Порядком**: Автоматические обновления поля `order_by`

### Система Валидации

#### Трехуровневая Валидация

1. **Уровень Формы** (Схема Zod):

   ```typescript
   const schema = buildQuestFormSchema(presetId);
   ```

2. **Уровень Пресета** (Бизнес-Правила):

   ```typescript
   if (presetId === 'connect' && !provider) {
     addError('Провайдер обязателен для пресета Connect');
   }
   ```

3. **Уровень API** (Валидация Бэкенда):
   - Финальная валидация перед сохранением в базу данных
   - Проверки совместимости типов
   - Валидация ресурсов

---

## Интеграция с API

### Конечные Точки

- **Создать Квест**: `POST /api/admin/tasks`
- **Получить Квест**: `GET /api/admin/tasks/:id`
- **Список Квестов**: `GET /api/admin/tasks`
- **Обновить Квест**: `PUT /api/admin/tasks/:id`
- **Удалить Квест**: `DELETE /api/admin/tasks/:id`

### Поток Данных

#### Адаптер Формы в API

Функция `formToApi` преобразует данные формы в формат, совместимый с API:

```typescript
const apiData = formToApi(formValues);
// Преобразует: QuestFormValues → CreateTaskDto
```

#### Создание Дочерней Задачи

Дочерние задачи создаются с автоматической привязкой `parent_id`:

```typescript
const childApiData = {
  ...baseChildData,
  parent_id: parentTask.id,
  // Наследуемые свойства от родителя
  enabled: child.enabled ?? parent.enabled,
  web: child.web ?? parent.web,
  twa: child.twa ?? parent.twa,
};
```

---

## UI Компоненты

### Компоненты Формы Квеста

#### `QuestFormContainer`

- Главная обертка формы с поддержкой мульти-задач
- Интеграция отслеживания прогресса
- Обработка граничных ошибок

#### `QuestFormFields`

- Динамический рендеринг полей на основе пресета
- Условная видимость полей
- Применение бизнес-правил

#### `ChildrenEditor`

- Интерфейс управления дочерними задачами
- Функциональность перетаскивания
- Рендеринг полей, специфичных для типа

#### `MultiTaskProgress`

- Прогресс создания в реальном времени
- Отображение ошибок и опции повтора
- Поддержка отмены

### Специализированные Компоненты

#### `TwitterPreview`

- Предпросмотр твита с резервным вариантом по таймауту
- Используется в пресете `action-with-post`
- Таймаут 8-10 секунд с заполнителем

#### `TasksEditor`

- Управление задачами Like/Comment/Retweet
- Используется в пресетах социальных сетей
- Динамический выбор типа задачи

---

## Руководство по Разработке

### Добавление Новых Пресетов

1. **Создать Конфигурацию Пресета**:

   ```typescript
   // src/features/quests/presets/configs/my-preset.ts
   export const myPresetConfig: PresetConfig = {
     id: 'my-preset',
     name: 'Мой Кастомный Пресет',
     fieldVisibility: { /* конфигурация */ },
     defaults: { /* значения по умолчанию */ },
     businessRules: [ /* правила */ ],
   };
   ```

2. **Зарегистрировать Пресет**:

   ```typescript
   // src/features/quests/presets/registry.ts
   import { myPresetConfig } from './configs/my-preset';

   export const presetRegistry = {
     'my-preset': myPresetConfig,
     // ... другие пресеты
   };
   ```

3. **Добавить Правила Валидации**:

   ```typescript
   // src/features/quests/types/form-schema.ts
   if (presetId === 'my-preset') {
     // Добавить валидацию, специфичную для пресета
   }
   ```

### Расширение Типов Дочерних Задач

1. **Обновить Типы**:

   ```typescript
   // src/features/quests/types/form-types.ts
   export const CHILD_TYPES = [
     'like', 'share', 'comment', 'join', 'connect',
     'my-new-type'  // Добавить новый тип
   ] as const;
   ```

2. **Обновить Редактор Дочерних**:

   ```typescript
   // src/features/quests/components/children-editor.tsx
   const childTypes = types.filter((type) =>
     ['like', 'share', 'comment', 'join', 'my-new-type'].includes(type.value)
   );
   ```

3. **Добавить Валидацию**:

   ```typescript
   // Обновить схему формы для обработки нового типа
   ```

### Лучшие Практики

1. **Конфигурация в Первую Очередь**: Используйте пресеты для определения поведения
2. **Паттерн Наследования**: Дочерние задачи должны наследовать от родителей
3. **Прогрессивное Улучшение**: Начинайте просто, добавляйте сложность постепенно
4. **Обработка Ошибок**: Всегда обрабатывайте сценарии частичного успеха
5. **Безопасность Типов**: Поддерживайте строгие типы TypeScript
6. **Тестирование**: Тестируйте конфигурации пресетов и потоки мульти-задач

### Соображения Производительности

1. **Последовательное Создание**: Дочерние задачи создаются по одной (не параллельно)
2. **Обновления Прогресса**: Обновления состояния в реальном времени для обратной связи с пользователем
3. **Восстановление после Ошибок**: Механизм повтора для неудачных дочерних задач
4. **Управление Памятью**: Очистка состояния после завершения

---

## Будущие Улучшения

### Планируемые Функции

1. **Продвинутые Дочерние Задачи**:
   - Условное выполнение дочерних задач
   - Вложенные дочерние (внуки)
   - Перекрестные ссылки между дочерними задачами

2. **Улучшенные Пресеты**:
   - `daily-checkin`: Повторяющиеся ежедневные задачи
   - `partner-collaboration`: Многопартнерские кампании
   - `tournament-style`: Серии соревновательных квестов

3. **Улучшения UI**:
   - Визуальный конструктор квестов
   - Массовые операции с дочерними задачами
   - Режим предпросмотра квеста
   - Совместное использование шаблонов

4. **Интеграция Аналитики**:
   - Метрики производительности квестов
   - Отслеживание уровня завершения
   - Аналитика вовлечения пользователей

### Путь Миграции

Система спроектирована для обратной совместимости. Новые функции добавляются через:

- Расширения конфигурации пресетов
- Дополнения опциональных полей
- Паттерны прогрессивного улучшения
- Изящные резервные варианты для старых квестов

---

## Заключение

Система Квестов предоставляет комплексную, гибкую платформу для управления пользовательскими задачами и наградами. Через свою систему конфигурации на основе пресетов и возможности мульти-задач, она поддерживает широкий спектр случаев использования при сохранении последовательности и простоты использования.

Архитектура делает акцент на конфигурации вместо кода, паттернах наследования и прогрессивном улучшении, делая её как мощной для сложных сценариев, так и доступной для простого создания квестов.
